# GUI_spectrum_v1_6 — README (English)

This document describes how to set up and use `GUI_spectrum_v1_6.py`.

Purpose
- Capture an ROI (region of interest) from a camera, compute an averaged luminance profile from the crop, and show/save the spectrum and crop image.
- The wavelength axis in v1_6 is fixed to 400 nm — 700 nm.

Prerequisites
- Python 3 (3.8+ recommended)
- System packages (example for Debian / Raspberry Pi OS):
  - python3-tk (Tkinter GUI support)
  - libcamera and Picamera2 runtime on Raspberry Pi

Python packages (install via pip):
- numpy
- pillow
- matplotlib
- opencv-python
- picamera2 (if using Raspberry Pi Picamera2)

Recommended install commands (Debian / Raspberry Pi OS):

```bash
# system deps (run as root)
sudo apt update
sudo apt install -y python3-pip python3-tk libcamera-apps
# On some Raspberry Pi systems, picamera2 may be available as an apt package:
# sudo apt install -y python3-picamera2

# python packages (user install)
python3 -m pip install --user numpy pillow matplotlib opencv-python
# if picamera2 is available via pip: 
python3 -m pip install --user picamera2
```

Notes
- On Raspberry Pi, Picamera2 typically depends on libcamera and vendor-specific components. Follow the Raspberry Pi documentation if you get camera initialization errors.
- If you prefer a headless OpenCV, you can install `opencv-python-headless` instead of `opencv-python` (but this project uses Pillow for display, so headless is usually safe).

Start the GUI

```bash
cd /home/pi2172/Documents/python/spectrometer
python3 GUI_spectrum_v1_6.py
```

You can run a quick syntax check with:

```bash
python3 -m py_compile GUI_spectrum_v1_6.py
```

Typical usage flow
1. Ensure the camera is connected and the OS camera stack is enabled (Raspberry Pi: use raspi-config if needed).
2. Launch the GUI.
3. Select an ROI (region of interest): click `Select ROI` or `Re-select ROI` to open the ROI dialog. Drag a rectangle on the preview image and press OK to save the ROI (`roi.json`).
4. (Optional) Click `Capture Background` to average frames and store a background measurement (used for subtraction during spectrum capture).
5. Enter the desired integration time (seconds) in the `Integration time (s)` field.
6. Click `Capture Spectrum` to acquire frames for the specified integration time, average them, compute luminance (L = 0.299*R + 0.587*G + 0.114*B), optionally subtract the background, and produce a spectrum plotted on a 400–700 nm x-axis.
7. Use `Save Plot`, `Save Crop`, or `Export CSV` to save results.
8. If colors look reversed (e.g., red appears blue), toggle the `Swap R↔B` checkbox to flip R and B channels for capture/display.

What each button / control does
- Capture Spectrum
  - Acquire frames for the configured integration time, average pixel columns in the ROI, compute luminance, subtract background if available, plot spectrum, update the crop preview, and write a CSV to the temporary path.

- Select ROI
  - Open ROI selector. Preview a camera frame and drag to choose an ROI. Press OK to save ROI to `roi.json`.

- Re-select ROI
  - Reopen the ROI selector to change the saved ROI.

- Capture Background
  - Average frames for the integration time and save the averaged crop as a background measurement. Used for background subtraction.

- Calibration
  - Open a calibration window where you can pick pixel positions on the spectrum plot and assign corresponding wavelengths. The code performs a linear fit wl = a * pixel + b and stores the coefficients.

- Save Plot
  - Save the current plot PNG (file chooser will ask where to save).

- Save Crop
  - Save the averaged crop image produced by the last capture.

- Export CSV
  - Export the table (wavelength, L, correction factor, corrected luminance) to CSV.

- Swap R↔B (checkbox)
  - When checked, the GUI will swap R and B channels on captured frames. Use this if your camera or capture pipeline yields BGR arrays instead of RGB.

Files generated by the program (temporary / persistent)
- Temporary plot PNG: /tmp/spectrum_wavelength_plot.png
- Temporary CSV: /tmp/spectrum_wavelength.csv
- Latest averaged crop: /tmp/roi_crop_latest.jpg
- ROI settings (persistent in project): `roi.json`

Troubleshooting
- Syntax/Indentation errors: ensure the file is not partially edited. Use `python3 -m py_compile GUI_spectrum_v1_6.py` to check.
- Camera initialization errors: verify libcamera/Picamera2 installation and that the camera is enabled in OS settings.
- Color inversion: try `Swap R↔B` checkbox. If that fixes colors, consider making the option persistent or adding an auto-detection routine later.

Developer notes
- The wavelength axis is fixed to 400–700 nm in v1_6 (search for `ax.set_xlim(400.0, 700.0)`).
- Imaging pipeline uses Pillow (ImageTk) for display and Matplotlib prints figures to PNG files which are reloaded for Tkinter display.

Change log (brief)
- v1_6: Based on v1_5; translated UI text to English, fixed plot x-axis to 400–700 nm, added R/B swap UI, refactored image helpers, and aligned crop display width to the plot display.

If you want, I can:
- Integrate this English README into `README.md` (replace or append).
- Produce a short quickstart script / test that verifies camera capture on your device.
- Add persistence for the Swap R↔B setting.

Which of those would you like next?